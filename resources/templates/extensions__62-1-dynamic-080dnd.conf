; Dynamic 080 dnd

[dynamic-080dnd]
; ${DIPCAST-CHANNEL-SERVICENUMBER} : 서비스 번호
; ${DIPCAST-CHANNEL-INPUT-CIDNUMBER} : 080DND 등록번호
; ${080DND-BRAND} : 재생할 파일 이름 
; ${080DND-TYPE} : 080DND 운영 방식, SHORT -> 수신 후 바로 번호 입력 

exten => init,1,NoOp(DYNAMIC 080 DND, ${DIPCAST-CHANNEL-CIDNUMBER}, ${DIPCAST-CHANNEL-SERVICENUMBER}, ${DIPCAST-CHANNEL-LINKEDID})
 same => n,Answer()
 ; User Setting
 same => n,Set(DIPCAST-CHANNEL-SERVICENUMBER=0801112222)
 same => n,Set(080DND-BRAND=) 
 same => n,Set(080DND-TYPE=SHORT) 
 same => n,ExecIf($["${ISNULL(${080DND-BRAND})}"="1"]?Set(080DND-BRAND=080-dnd-intro-brand):) 
 same => n,BackGround(silence/1&custom/${080DND-BRAND})
 same => n(welcome-background),BackGround(custom/080-dnd-intro)
 same => n,GotoIf($["${080DND-TYPE}"="SHORT"]?dynamic-080-dnd-input-number,init,1)
 same => n,Playback(custom/080-dnd-play-cidnumber-pre)
 same => n,SayDigits(${DIPCAST-CHANNEL-CIDNUMBER})
 same => n,Playback(custom/yipnida)
 same => n,Set(INVALIDATTEMPTS=0)
 same => n,Set(TIMEOUTATTEMPTS=0)
 same => n,Set(TIMEOUT(digit)=2)
 same => n,Set(TIMEOUT(response)=5)
 same => n,Set(__PBX_APP_DESC=등록 번호가 맞으면 1번, 아니면 2번)
 same => n(begin),NoOp(IVR Menu Begin)
 same => n(retry),NoOp(IVR Retry Section)
 same => n(retry-background),BackGround(custom/080-dnd-confrim-1-2)
 same => n,WaitExten(5)

exten => 1,1,NoOp(1번 누름, ${DIPCAST-CHANNEL-INPUT-CIDNUMBER})
 same => n,Set(__SRC_APP=IVR)
 same => n,Set(DIPCAST-CHANNEL-INPUT-CIDNUMBER=${IF($["${ISNULL(${DIPCAST-CHANNEL-INPUT-CIDNUMBER})}"="1"]?${DIPCAST-CHANNEL-CIDNUMBER}:${DIPCAST-CHANNEL-INPUT-CIDNUMBER})})
 same => n,Playback(custom/080-dnd-complete)
 same => n,UserEvent("080dnd","Registration: ${DIPCAST-CHANNEL-INPUT-CIDNUMBER}, ${DIPCAST-CHANNEL-SERVICENUMBER}, ${DIPCAST-CHANNEL-LINKEDID}")
 same => n,Set(CHANNEL(accountcode)=${DIPCAST-CHANNEL-SERVICENUMBER})
 same => n,Set(CDR(customer_code)=${DIPCAST-CHANNEL-INPUT-CIDNUMBER})
 same => n,Playback(custom/goodbye)

exten => 2,1,NoOp(2번 누름, ${DIPCAST-CHANNEL-INPUT-CIDNUMBER})
 same => n,Set(__SRC_APP=IVR)
 same => n,Set(CALL_DESTINATION=${EXTEN})
 same => n,Goto(dynamic-080-dnd-input-number,init,1)

exten => *,1,Goto(init,begin)

exten => t,1,Set(TIMEOUTATTEMPTS=$[${TIMEOUTATTEMPTS}+1])
 same => n,GotoIf($[${TIMEOUTATTEMPTS}>=3]?timeout-hangup)
 same => n(timeout),BackGround(custom/080-dnd-timeout)
 same => n,Goto(init,begin)
 same => n(timeout-hangup),BackGround(custom/080-dnd-end-retry)
 same => n,Goto(h,1)

exten => i,1,Set(INVALIDATTEMPTS=$[${INVALIDATTEMPTS}+1])
 same => n,GotoIf($[${INVALIDATTEMPTS}>=3]?invalid-hangup)
 same => n(invalid),BackGround(custom/080-dnd-incorrect)
 same => n,Goto(init,begin)
 same => n(invalid-hangup),BackGround(custom/080-dnd-end-retry)
 same => n,Goto(h,1)

exten => invalid_dial,1,NoCDR()
 same => n,NoOp(Invalid Numbering Dial)
 same => n,Playback(silence/1&no-route-exists-to-dest&vm-pls-try-again)
 same => n,Set(INVALID_DIAL=yes)
 same => n,Goto(i,1)

exten => h,1,NoOp(HANGUP)
 same => n,Hangup()

[dynamic-080-dnd-input-number] 
exten => init,1,NoOp(DYNAMIC 080 DND INPUT NUMBER, ${080DND-TYPE}, ${DIPCAST-CHANNEL-CIDNUMBER}, ${DIPCAST-CHANNEL-SERVICENUMBER}, ${DIPCAST-CHANNEL-LINKEDID})
 same => n,Set(INVALIDATTEMPTS=0)
 same => n,Set(TIMEOUTATTEMPTS=0)
 same => n,Set(TIMEOUT(digit)=2)
 same => n,Set(TIMEOUT(response)=5)
 same => n,Set(__PBX_APP_DESC=등록을 원하는 번호를 입력하시고 우물정자를 누르세요)
 same => n,Answer()
 same => n(begin),NoOp(IVR Menu Begin)
 ;same => n(welcome-background),BackGround(silence/1&custom/080-dnd-intro)
 same => n(retry),NoOp(IVR Retry Section)
 same => n(retry-background),ExecIf($["${080DND-TYPE}"="SHORT"]?BackGround(silence/1&custom/080-dnd-input-number):BackGround(silence/1&custom/080-dnd-input-number-short))
 same => n,WaitExten(5)

exten => _01[156789]XXXXXXX#,1,NoOp(Korea Mobile Number ${EXTEN})
 same => n,Set(DIPCAST-CHANNEL-INPUT-CIDNUMBER=${EXTEN:0:-1})
 same => n,GotoIf($["${LEN(${DIPCAST-CHANNEL-INPUT-CIDNUMBER})}">"10"]?invalid_number,1)
 same => n,Playback(custom/080-dnd-play-inputnumber-pre)
 same => n,SayDigits(${DIPCAST-CHANNEL-INPUT-CIDNUMBER})
 same => n,Playback(custom/yipnida)
 same => n,Goto(dynamic-080dnd,init,retry-background)

exten => _010XXXXXXXX#,1,NoOp(Korea Mobile Number ${EXTEN})
 same => n,Set(DIPCAST-CHANNEL-INPUT-CIDNUMBER=${EXTEN:0:-1})
 same => n,GotoIf($["${LEN(${DIPCAST-CHANNEL-INPUT-CIDNUMBER})}">"11"]?invalid_number,1)
 same => n,Playback(custom/080-dnd-play-inputnumber-pre)
 same => n,SayDigits(${DIPCAST-CHANNEL-INPUT-CIDNUMBER})
 same => n,Playback(custom/yipnida)
 same => n,Goto(dynamic-080dnd,init,retry-background)

exten => *,1,Goto(init,begin)

exten => t,1,Set(TIMEOUTATTEMPTS=$[${TIMEOUTATTEMPTS}+1])
 same => n,GotoIf($[${TIMEOUTATTEMPTS}>=3]?timeout-hangup)
 same => n(timeout),BackGround(custom/080-dnd-timeout)
 same => n,Goto(init,begin)
 same => n(timeout-hangup),BackGround(custom/080-dnd-end-retry)
 same => n,Goto(h,1)

exten => i,1,Set(INVALIDATTEMPTS=$[${INVALIDATTEMPTS}+1])
 same => n,GotoIf($[${INVALIDATTEMPTS}>=3]?invalid-hangup)
 same => n(invalid),BackGround(custom/080-dnd-wrong-mobile-number)
 same => n,Goto(init,begin)
 same => n(invalid-hangup),BackGround(custom/080-dnd-end-retry)
 same => n,Goto(h,1)
 
exten => invalid_number,1,NoOp(모바일 번호 여부)
 same => n,GotoIf($[${INVALIDATTEMPTS}>=3]?invalid-hangup)
 same => n(invalid),BackGround(custom/080-dnd-wrong-mobile-number)
 same => n,Goto(init,begin)
 same => n(invalid-hangup),BackGround(custom/080-dnd-end-retry)
 same => n,Goto(h,1)

exten => h,1,NoOp(HANGUP)
 same => n,Hangup()
 
; Return 서브 루틴 복귀
same => n,NoOp(080DND 종료, ${DIPCAST-CHANNEL-INPUT-CIDNUMBER}, ${DIPCAST-CHANNEL-SERVICENUMBER}, ${DIPCAST-CHANNEL-LINKEDID})
same => n(return),Return()